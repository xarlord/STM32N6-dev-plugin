/**
 * I2C Driver Template
 * Generated for STM32N6570-DK
 */

#ifndef __I2C_DRIVER_H
#define __I2C_DRIVER_H

#ifdef __cplusplus
extern "C" {
#endif

#include <stdint.h>
#include <stdbool.h>
#include "stm32n6xx_hal.h"

/* I2C instance enumeration */
typedef enum {
    I2C_INSTANCE_1 = 0,
    I2C_INSTANCE_2,
    I2C_INSTANCE_3,
} I2C_Instance_t;

/* I2C configuration structure */
typedef struct {
    I2C_Instance_t instance;
    uint32_t clockSpeed;        /* Clock speed in Hz (100000, 400000, 1000000) */
    uint8_t ownAddress;         /* Own address (for slave mode) */
    bool addressingMode;        /* 0 = 7-bit, 1 = 10-bit */
    bool generalCallMode;       /* General call enable */
    bool noStretchMode;         /* Clock stretching disable */
    bool useDma;                /* Enable DMA transfers */
    bool useInterrupts;         /* Enable interrupts */
} I2C_Config_t;

/* I2C status enumeration */
typedef enum {
    I2C_OK = 0,
    I2C_ERROR = -1,
    I2C_BUSY = -2,
    I2C_TIMEOUT = -3,
    I2C_NACK = -4,
    I2C_ARBITRATION_LOST = -5,
    I2C_INVALID_PARAM = -6,
} I2C_Status_t;

/* I2C handle structure */
typedef struct {
    I2C_HandleTypeDef hi2c;
    I2C_Config_t config;

    /* State tracking */
    volatile bool isInitialized;
    volatile bool isBusy;
    volatile I2C_Status_t lastError;

    /* Transfer state */
    volatile uint8_t *buffer;
    volatile uint16_t bufferLen;
    volatile uint16_t bytesTransferred;

    /* Callbacks */
    void (*txCompleteCallback)(void);
    void (*rxCompleteCallback)(void);
    void (*errorCallback)(I2C_Status_t error);
} I2C_Handle_t;

/* Function prototypes */

/**
 * @brief Initialize I2C peripheral
 * @param handle Pointer to I2C handle
 * @param config Pointer to configuration structure
 * @return I2C_Status_t
 */
I2C_Status_t I2C_Init(I2C_Handle_t *handle, const I2C_Config_t *config);

/**
 * @brief Deinitialize I2C peripheral
 * @param handle Pointer to I2C handle
 * @return I2C_Status_t
 */
I2C_Status_t I2C_DeInit(I2C_Handle_t *handle);

/**
 * @brief Transmit data in master mode (blocking)
 * @param handle Pointer to I2C handle
 * @param devAddress Target device address (7-bit)
 * @param data Pointer to data buffer
 * @param len Number of bytes to transmit
 * @param timeout Timeout in milliseconds
 * @return I2C_Status_t
 */
I2C_Status_t I2C_Master_Transmit(I2C_Handle_t *handle, uint8_t devAddress,
                                  const uint8_t *data, uint16_t len, uint32_t timeout);

/**
 * @brief Receive data in master mode (blocking)
 * @param handle Pointer to I2C handle
 * @param devAddress Target device address (7-bit)
 * @param data Pointer to data buffer
 * @param len Number of bytes to receive
 * @param timeout Timeout in milliseconds
 * @return I2C_Status_t
 */
I2C_Status_t I2C_Master_Receive(I2C_Handle_t *handle, uint8_t devAddress,
                                 uint8_t *data, uint16_t len, uint32_t timeout);

/**
 * @brief Transmit data in master mode (DMA)
 * @param handle Pointer to I2C handle
 * @param devAddress Target device address (7-bit)
 * @param data Pointer to data buffer
 * @param len Number of bytes to transmit
 * @return I2C_Status_t
 */
I2C_Status_t I2C_Master_Transmit_DMA(I2C_Handle_t *handle, uint8_t devAddress,
                                      const uint8_t *data, uint16_t len);

/**
 * @brief Receive data in master mode (DMA)
 * @param handle Pointer to I2C handle
 * @param devAddress Target device address (7-bit)
 * @param data Pointer to data buffer
 * @param len Number of bytes to receive
 * @return I2C_Status_t
 */
I2C_Status_t I2C_Master_Receive_DMA(I2C_Handle_t *handle, uint8_t devAddress,
                                     uint8_t *data, uint16_t len);

/**
 * @brief Write data to specific register
 * @param handle Pointer to I2C handle
 * @param devAddress Target device address (7-bit)
 * @param reg Register address
 * @param data Pointer to data buffer
 * @param len Number of bytes to write
 * @param timeout Timeout in milliseconds
 * @return I2C_Status_t
 */
I2C_Status_t I2C_MEM_Write(I2C_Handle_t *handle, uint8_t devAddress, uint8_t reg,
                            const uint8_t *data, uint16_t len, uint32_t timeout);

/**
 * @brief Read data from specific register
 * @param handle Pointer to I2C handle
 * @param devAddress Target device address (7-bit)
 * @param reg Register address
 * @param data Pointer to data buffer
 * @param len Number of bytes to read
 * @param timeout Timeout in milliseconds
 * @return I2C_Status_t
 */
I2C_Status_t I2C_MEM_Read(I2C_Handle_t *handle, uint8_t devAddress, uint8_t reg,
                           uint8_t *data, uint16_t len, uint32_t timeout);

/**
 * @brief Check if device is ready
 * @param handle Pointer to I2C handle
 * @param devAddress Target device address (7-bit)
 * @param trials Number of trials
 * @param timeout Timeout in milliseconds
 * @return I2C_Status_t
 */
I2C_Status_t I2C_IsDeviceReady(I2C_Handle_t *handle, uint8_t devAddress,
                                uint32_t trials, uint32_t timeout);

#ifdef __cplusplus
}
#endif

#endif /* __I2C_DRIVER_H */
